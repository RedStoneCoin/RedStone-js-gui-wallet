<!DOCTYPE html>
<html>
    <head>
        <title>Aviro wallet</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="src/css/style.css">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="icon" href="favicon.ico" type="image/x-icon">  
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>

        <script>
            function gocreatewallet() { // creates a wallet file then passes that data to index.html
                var walletname = document.getElementById("createwallet").elements[0].value;
                var pin = document.getElementById("createWalletPincode").value;
                let keys = ['7C82C886DD347EF34C865C7923DD3A0FDC46C16524C3BEE0113F2A50D8D880B3', '04BEE08EB35BCF7F49CD61FD3F4B48BB171518F704F04D3ACFA7FF5823D28DEAFF43A8159A47B183674AD15B48945ED30F9074FE06D40D71833E5DDA6742A072B0'];//generateKeypair();
                let privateKeyE = CryptoJS.AES.encrypt(keys[0], pin);
                let walletJSON = JSON.stringify({ version: 1, username: "none", publicKey: keys[0], privateKey: privateKeyE, advancedMode: "false"});
                localStorage.setItem("privateKey", keys[0]);
                localStorage.setItem("username", "none");
                localStorage.setItem("advancedMode","false");
                var fileBlob = new Blob(walletJSON,{type: "application/json"}); 
                if (username !== "none") {
                    download(fileBlob,"avrio-wallet-" + username); 
                }else {}
                download(fileBlob,"avrio-wallet" + keys[1]);
                function download(blob,name) {
				var url = URL.createObjectURL(blob),
					div = document.createElement("div"),
					anch = document.createElement("a");
 
				document.body.appendChild(div);
				div.appendChild(anch);
 
				anch.innerHTML = "&nbsp;";
				div.style.width = "0";
				div.style.height = "0";
				anch.href = url;
				anch.download = name;
				
				var ev = new MouseEvent("click",{});
				anch.dispatchEvent(ev);
				document.body.removeChild(div);
			}
 

                window.location.href("index.html");
            }
            function goviafile() { // Loads the data from a wallet file,  decrypts it (where needed) and then passes it to index.html (via loaclStorage)
                var file =  document.getElementById("walletFile").files[0];
                let key = document.getElementById("loadWalletPincode").value;
                var reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function (evt) {
                    var result = evt.target.result;
                }
                var parsed  = JSON.parse(result);
                //CryptoJS.AES.encrypt("Message", pin);
                //CryptoJS.AES.decrypt(encrypted, pin);
                var privateKey = CryptoJS.AES.decrypt(parsed.privateKey, key);
                privateKey = privateKey.toString(CryptoJS.enc.Utf8);
                localStorage.setItem("privateKey", privateKey);
                localStorage.setItem("username", parsed.username);
                localStorage.setItem("advancedMode",parsed.advancedMode);
                window.location.href("index.html");
            }
            function goviapk() { // passes privateKey to index.html
                localStorage.setItem("privateKey", document.getElementById("viapk").elements[0].value);
                window.location.href("index.html");
            }
        </script>
        <div class="main">

            <div class="card card-top">
                <div class="logo-group">
                    <img class="logo" src="img/logo.png">

                    <h3>Aviro</h3>
                </div>
            </div>

            <div class="card">
                <center>
                    <h2>Load wallet</h2>
                    <br>
                    <input type="file" id="walletFile" name="walletFile" style="display: none;">
                    <button onclick="document.getElementById('walletFile').click();" class="button" id="sendTransactionButton" href="#"><i class="fixicon" data-feather="upload"></i> Choose Wallet file</button>
                    <br><br><br>
                    <h5 class="grey">Enter your pin</h5>
                    
                    <div class="pincode-group">
                        <!-- Pincode is stored here -->
                        <input id="loadWalletPincode" autocomplete="off" style="display: none;">
                        
                        <!-- Ignore below! Get pincode from above input-->
                        <input id="pin1" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pin2" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pin3" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pin4" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pin5" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pin6" autocomplete="off" class="pincodeInput" type="text">
                    </div>

                    <br>

                    <button style="width: 50%;" class="button primary"  href="#">Load</button>

                </center>
            </div>

            <div class="card">
                <center>
                    <h2> Create Wallet: </h2>
                </center>
                <br>
                <form id="createwallet">
                    <h5 class="grey"> Choose Wallet name: </h5> 
                    <div class="inputGroup">
                        <input id="walletName" type="text" class="amount" autocomplete="off">
                        <div class="amountSuffix" onclick='document.getElementById("walletName").value = ""; document.getElementById("walletName").focus();'>
                            <i data-feather="x-circle"></i>
                        </div> 
                    </div>

                    <br>

                    <h5 class="grey"> Choose your pin: </h5> 

                    <div class="pincode-group choose">
                        <!-- Pincode is stored here -->
                        <input id="createWalletPincode" autocomplete="off" style="display: none;">
                        
                        <!-- Ignore below! Get pincode from above input-->
                        <input id="pinc1" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pinc2" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pinc3" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pinc4" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pinc5" autocomplete="off" class="pincodeInput" type="text">
                        <input id="pinc6" autocomplete="off" class="pincodeInput" type="text">
                    </div>

                    <p><b>NOTE:</b> A pin must be 6 numbers long and is used to unlock your wallet, if you foget your pin you will loose access to your wallet <u><i>forever</i></u></p>
                    <br><br>
                </form>

                <center>
                    <button onclick="gocreatewallet()" style="width: 50%;" class="button primary"  href="#">Create</button>
                </center>

            </div>

            <div class="card">
                <center>
                    <h2> Load Wallet From a Private Key: </h2>
                </center>
                <br>
                <form id="viapk">
                    <h5 class="grey">Enter your private key: </h5> 
                    <div class="inputGroup">
                        <input id="privKey" type="text" class="amount" autocomplete="off" minlength="32" maxlength="32">
                        <div class="amountSuffix" onclick='document.getElementById("privKey").value = ""; document.getElementById("privKey").focus();'>
                            <i data-feather="x-circle"></i>
                        </div> 
                    </div>
                </form>
                <!--pk should be 32 bytes long, example: 0C28FCA386C7A227600B2FE50B7CAE11EC86D3BF1FBE471BE89827E19D72AA1D -->
                <br>
                <center>
                    <button onclick="goviapk()" style="width: 50%;" class="button primary"  href="#">Load</button>
                </center>
            </div>
        </div>
        <p id="test"></p>
        <script src="https://unpkg.com/feather-icons"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="src/js/components.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
        <script>
            pinCodeStart();
            feather.replace();
        </script>
    </body>
</html>
